<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Radar Yakınlık Uyarısı</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <style>
      #map {
        height: 90vh;
        width: 100%;
      }
      #alert {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #f44336;
        color: white;
        padding: 10px 20px;
        font-weight: bold;
        display: none;
        border-radius: 5px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <div id="alert"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
      // Radar noktaları JSON formatında
      const markers = [
        {
          Aciklama:
            "31019 / Laiklik Cad. Büyükkılıçlı SİLİVRİ Büyükkılıçlı-D100 istikametine",
          lat: 41.16418,
          lng: 28.189972,
        },
        {
          Aciklama:
            "12017 / Kennedy Cad. Ahırkapı FATİH  Kennedy Cad.-Sirkeci istikametine",
          lat: 41.00399,
          lng: 28.982493,
        },
        {
          Aciklama:
            "03004 / Eski Havaalanı Cad. BAKIRKÖY  Bakırköy-sahilyolu istikametine",
          lat: 40.96419,
          lng: 28.817257,
        },
      ];

      // Ses objesi (sayfa yüklendiğinde oluşturuyoruz)
      const alertSound = new Audio(
        "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
      );
      alertSound.volume = 0.5;

      // Harita ayarları
      const map = L.map("map").setView([41.0, 28.8], 11);

      // OpenStreetMap katmanı
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution:
          'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Radar işaretçilerini ekle
      markers.forEach((data) => {
        L.marker([data.lat, data.lng]).addTo(map).bindPopup(data.Aciklama);
      });

      let lastAlertTime = 0; // Son ses uyarısı zamanı (milisaniye)
      const alertCooldown = 15000; // 15 saniye bekle (aynı uyarı için)

      // Kullanıcı konumunu alma ve radar ile mesafe kontrolü
      function onLocationFound(e) {
        const userLatLng = e.latlng;

        // Kullanıcı işaretçisi
        L.marker(userLatLng, { title: "Senin Konumun" })
          .addTo(map)
          .bindPopup("Buradasın")
          .openPopup();

        // Mesafe kontrolü (metre cinsinden)
        let alertShown = false;
        markers.forEach((radar) => {
          const radarLatLng = L.latLng(radar.lat, radar.lng);
          const distance = userLatLng.distanceTo(radarLatLng);
          if (distance <= 50000) {
            // 50 km içinde ise uyar
            showAlert(
              `Dikkat! ${radar.Aciklama} radarına ${Math.round(
                distance
              )} metre yaklaştınız.`
            );
            alertShown = true;

            // Sadece cooldown süresi geçtiyse sesi çal
            const now = Date.now();
            if (now - lastAlertTime > alertCooldown) {
              alertSound.play().catch(() => {
                // Eğer izin sorunu olursa sessiz kal
              });
              lastAlertTime = now;
            }
          }
        });

        if (!alertShown) {
          hideAlert();
        }
      }

      function onLocationError(e) {
        alert("Konum bilgisi alınamadı. Lütfen konum izinlerini kontrol edin.");
      }

      // Uyarı gösterme fonksiyonları
      function showAlert(msg) {
        const alertDiv = document.getElementById("alert");
        alertDiv.innerText = msg;
        alertDiv.style.display = "block";
      }

      function hideAlert() {
        const alertDiv = document.getElementById("alert");
        alertDiv.style.display = "none";
      }

      // Konum iste
      map.locate({ setView: true, maxZoom: 16, watch: true });
      map.on("locationfound", onLocationFound);
      map.on("locationerror", onLocationError);
    </script>
  </body>
</html>
